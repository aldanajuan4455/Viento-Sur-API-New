{% extends 'VientoSurAppAppBundle::layoutHotel.html.twig' %}

{% block content %}
    <div class="container">
        <ul class="breadcrumb">
            <li><a href="#">Viento Sur</a></li>
            <li><a href="#">Hoteles en {{ app.session.get('destination').text }} ({{ items.paging.total }})</a></li>
        </ul>

        <h4 class="booking  s-title"><span class="totalHotels">{{ items.paging.total }}</span> hoteles disponibles para estas fechas en {{ app.session.get('destination').text }} con mejor precio</h4>

        <div class="row">

            <div class="col-md-3">
                {% include 'VientoSurAppAppBundle:Hotel:searchMenuLeft.html.twig' %}
            </div>

            <div class="col-md-9">
                <div class="nav-drop booking-sort">
                    <h5 class="booking-sort-title"><a href="#">Ordenar por: <span id="sortSelected">{{ attribute(sortMapping, sorting) }}</span><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></a></h5>
                    <ul class="nav-drop-menu">
                        {% if items.sorting is defined %}
                            {% for item in items.sorting.values %}
                                {% if attribute(sortMapping, item.value) is defined %}
                                    <li><a href="javascript:void(0);"  class="nav-drop-menu-a" data-value="{{ item.value }}">{{ attribute(sortMapping, item.value) }}</a></li>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <li><a href="#">Más elegidos</a></li>
                        {% endif %}
                    </ul>
                </div>
                <ul class="booking-list">
                    {% include 'VientoSurAppAppBundle:Hotel:listDetailHotels.html.twig' %}
                </ul>
                <div class="row">
                    <div class="col-md-12">
                        <p class="sfont mb20"><span class="totalHotels">{{ items.paging.total }}</span> hoteles encontrados.</p>
                        <ul class="pagination" id="pagination">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="gap"></div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(document).ready(function () {

            function asynLoad(queryParams, callback, callbackError) {
                var url = window.location.pathname;
                var obj = null;
                for (var key in queryParams) {
                    if (queryParams.hasOwnProperty(key)) {
                        if (queryParams[key] != '') {
                            obj = (!obj) ? $.query.set(key, queryParams[key]) : obj.set(key, queryParams[key]);
                        } else {
                            obj = (!obj) ? $.query.REMOVE(key) : obj.REMOVE(key);
                        }
                    }
                }
                var search = decodeURIComponent((!obj) ? $.query.toString() : obj.toString());

                waitingDialog.show('Viento Sur, Cargando...');
                $("html, body").animate({ scrollTop: 0 }, "slow");
                $.ajax({
                    url: url + search,
                    type: 'GET',
                    dataType: 'json'
                }).done(function (data) {
                    $(".booking-list").html(data.html);
                    if (history.pushState) {
                        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + search;
                        window.history.pushState({path: newurl}, '', newurl);
                        $.query.parseNew(search);
                    }
                    if (typeof callback == 'function') {
                        callback();
                    }
                    pagination.bootpag({total: data.total, page: data.page, maxVisible: 10});
                    $('.totalHotels').each(function () {
                        $(this).text(data.paging.total)
                    })
                }).fail(function () {
                    if (typeof callbackError == 'function') {
                        callbackError();
                    }
                }).always(function () {
                    waitingDialog.hide();
                });
            }

            var pagination = $("#pagination").bootpag({
                total: {{ total }},
                maxVisible:10,
                page: {{ page }} ,
                firstLastUse: true,
                first: '←',
                last: '→'
            }).on("page", function(event, num){
                asynLoad({
                    'page': num
                });
            });

            $('.nav-drop').dropit();

            {#Filtro por rango de precios#}
            $('.total_price_range').each(function () {
                $(this).removeClass('hidden');
                var slider = $("#price-slider").ionRangeSlider({
                    type: 'double',
                    hasGrid: true,
                    prefix: "$",
                    onChange: function () {
                        $('#priceBtn').removeClass('disabled');
                    }
                });
                $('#priceBtn').on('click', function () {
                    if (!$(this).hasClass('disabled')) {
                        var range = $('#price-slider').val();
                        if (range.length > 0) {
                            range = range.replace(';', '-');
                            asynLoad({
                                'price_range': range
                            });
                        }
                    }
                })
            });

            $("#field-hotel-checkin").datepicker({
                "setDate": new Date()
            });

            {#Orden de los elementos#}
            $('.nav-drop-menu-a').on('click', function () {
                var text = this.text;
                if (text != $('#sortSelected').text()) {
                    asynLoad({
                        'sorting' : $(this).data('value'),
                        'page': 1
                    }, function () {
                        $('#sortSelected').text(text);
                    })
                }
            });

            {#Filtro por estrellas#}
            $('.starts-filter').each(function () {
                $(this).find('.i-check').iCheck({
                    checkboxClass: 'i-check',
                    handle: 'checkbox'
                });
                $(this).find('input').on('ifChecked', function (event, a) {
                    var stars = $.query.get('stars');
                    if (stars != '') {
                        stars = stars.toString().split(',');
                        stars.push(this.value);
                        stars.sort(function (a, b) {
                            return b - a
                        });
                    } else {
                        stars = [this.value];
                    }
                    asynLoad({
                        'stars': stars.toString(),
                        'page': 1
                    })
                });
                $(this).find('input').on('ifUnchecked', function(event, a){
                    var stars = $.query.get('stars');
                    if (stars != '') {
                        stars = stars.toString().split(',');
                        var idx = stars.indexOf(this.value);
                        if(idx != -1){
                            stars.splice(idx, 1);
                        }
                    }
                    asynLoad({
                        'stars': stars.toString(),
                        'page': 1
                    })
                });
                $(this).removeClass('hidden');
            })
        })
    </script>
{% endblock %}
